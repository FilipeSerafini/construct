name: deploy-aws
on: [push]

jobs:
    deploy:
        name: Deploy to AWS
        runs-on: ubuntu-latest
        steps:

            - name: Checkout
              uses: actions/checkout@v2
              
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: "ASIAZQ3DR3Z3P6BVOOUX"
                  aws-secret-access-key: "TA+jGA0myV494iW5/JHL+Av7qZLFxID8+bVoOG74"
                  aws-session-token: "IQoJb3JpZ2luX2VjEG8aCXVzLXdlc3QtMiJHMEUCIQDE46faRuCynvR2Ys2/DPekNg89li/FxeSI9KxRR2oKNAIgTBqMkYCbYOWMuYO7kw2iBybAibV/63S8I1CWusb1OkQqswIIOBAAGgw2NTQ2NTQ0MzA4MzgiDOJDjtJuXJKL9SKO8SqQAry8CG+nPzPlrzfP3w1DK/jChkYeBRiPtIXYAFuhANYngG2MLjD2ol4RXHUCtWivF/obb/WmcGf2Qtt5w6nOFbSaLThF/2NQicEWqsMLAb8JY7KiOBXd81+P7QlmyjHMS5lUOkePER4IB1g8Kroyk18UFDwl40pThvaOEzRiscW5ne/tj0jrs/2GS1XMwk7MVWYOQNOJtCFvyWqPPD9Z81yJ4uDoYCiCve2RHdyc0C+n6Ipytlq1T1M+Z4K8joKE1Yaep84D3u2foYePcZxnhDLCioTZoIfZM2ND+GkgFNZvZVLFkBsz5NeUyTgemHsQutVnWsPsiCrRtzF7Rw21TtiIkLEp/p99pFqptCVnrjvKMJ75trQGOp0B5Hxukjhow6cPRua0lM1rKMt29oDVenN8nCBUjMipyXTS0EpgbEXj3tQjiucyniiXUDI3dfr7kSMuWOXyUcAXFXB1nmpfcJkgdkazpVpICv5cvVsiY9Iac56MbxfnGemXAdko+nOrrCMm216LCKyQKHGg70hQH1lBZkqL24JiKJ4ji3bJ5JsUvX2jydftTxNZ8W7/BbH0Pu9URpbMqQ=="
                  aws-region: us-east-1

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                terraform_wrapper: false

            - name: Terraform Apply
              run: |
                cd ./infra
                cd ./terraform-seller
                terraform init
                terraform plan
                terraform apply -auto-approve
                

            - name: Docker Hub 
              uses: docker/login-action@v2
              with:
                username: ${{ secrets.DHUB_USERNAME }}
                password: ${{ secrets.DHUB_PASSWORD }}

            - name: Build Docker image
              run: docker build . -t ${{ secrets.DHUB_USERNAME }}/seller-api:latest

            - name: Push Docker image
              run: docker push ${{ secrets.DHUB_USERNAME }}/seller-api:latest

           # - name: Create deployment
            #  run: |
             #   aws deploy create-deployment --application-name SellerInstance \
              #      --deployment-config-name CodeDeployDefault.OneAtATime \
               #     --deployment-group-name seller-group-pp \
                #    --s3-location bucket=${{ secrets.S3_BUCKET }},bundleType=zip,key=deployment.zip
